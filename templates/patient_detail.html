{% extends "base.html" %}

{% block title %}{{ patient.fullName }} - PHMS{% endblock %}

{% block content %}
<div class="patient-detail-page">
    <div class="page-header">
        <div>
            <a href="{{ url_for('patients.dashboard') }}" class="breadcrumb">‚Üê Patients</a>
            <h1>{{ patient.fullName }}</h1>
        </div>
    </div>
    
    <!-- Patient Summary Section -->
    <div class="detail-grid">
        <div class="summary-card">
            <h2>Patient Information</h2>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Age</span>
                    <span class="summary-value">{{ patient.age if patient.age else 'N/A' }}</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Gender</span>
                    <span class="summary-value">{{ patient.gender if patient.gender else 'N/A' }}</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Contact</span>
                    <span class="summary-value">{{ patient.contactNumber if patient.contactNumber else 'N/A' }}</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Email</span>
                    <span class="summary-value">{{ patient.email if patient.email else 'N/A' }}</span>
                </div>
                
                {% if patient.medicalConditions and patient.medicalConditions|length > 0 %}
                <div class="summary-item full-width">
                    <span class="summary-label">Medical Conditions</span>
                    <div class="conditions-tags">
                        {% for condition in patient.medicalConditions %}
                        <span class="condition-tag">{{ condition }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="actions-card">
            <h3>Actions</h3>
            <div class="action-buttons">
                <a href="{{ url_for('records.add_record_page', patient_id=patient._id) }}" class="btn btn-primary">
                    üìù Add Health Record
                </a>
                
                <button onclick="document.getElementById('uploadModal').style.display='flex'" class="btn btn-secondary">
                    üìÑ Upload Lab Report
                </button>
                
                <button onclick="confirmDeletePatient('{{ patient._id }}', '{{ patient.fullName }}')" class="btn btn-danger" style="background: #ef4444;">
                    üóëÔ∏è Delete Patient
                </button>
            </div>
            
            {% if latest_record %}
            <div class="latest-record">
                <h4>Latest Record</h4>
                <p class="record-date">{{ latest_record.timestamp.strftime('%B %d, %Y') if latest_record.timestamp else 'N/A' }}</p>
                <p class="record-source">
                    Source: 
                    <span class="badge badge-{{ 'ai' if latest_record.sourceType == 'REPORT_AI' else 'manual' }}">
                        {{ latest_record.sourceType }}
                    </span>
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-section">
        <h2>Health Trends</h2>
        
        <div class="charts-grid">
            <!-- Blood Sugar Chart -->
            <div class="chart-card">
                <h3>Blood Glucose</h3>
                <canvas id="sugarChart"></canvas>
            </div>
            
            <!-- Blood Pressure Chart -->
            <div class="chart-card">
                <h3>Blood Pressure</h3>
                <canvas id="bpChart"></canvas>
            </div>
            
            <!-- Lipid Profile Chart -->
            <div class="chart-card">
                <h3>Lipid Profile</h3>
                <canvas id="lipidsChart"></canvas>
            </div>
            
            <!-- Weight & BMI Chart -->
            <div class="chart-card">
                <h3>Weight & BMI</h3>
                <canvas id="weightChart"></canvas>
            </div>
            
            <!-- Kidney Function Chart -->
            <div class="chart-card">
                <h3>Kidney Function</h3>
                <canvas id="kidneyChart"></canvas>
            </div>
            
            <!-- Thyroid Chart -->
            <div class="chart-card">
                <h3>Thyroid Function</h3>
                <canvas id="thyroidChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Records Table -->
    <div class="records-section">
        <h2>Health Records History</h2>
        
        {% if records %}
        <div class="table-container">
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Source</th>
                        <th>Key Metrics</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.timestamp.strftime('%Y-%m-%d %H:%M') if record.timestamp else 'N/A' }}</td>
                        <td>
                            <span class="badge badge-{{ 'ai' if record.sourceType == 'REPORT_AI' else 'manual' }}">
                                {{ record.sourceType }}
                            </span>
                        </td>
                        <td>
                            <div class="metrics-summary">
                                {% set displayed_metrics = [] %}
                                
                                {# Priority order for displaying metrics - top to bottom by clinical importance #}
                                {# Priority 1: Blood Pressure #}
                                {% if record.bpSystolic and record.bpDiastolic %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">BP: {{ record.bpSystolic }}/{{ record.bpDiastolic }} mmHg</span>
                                {% endif %}
                                
                                {# Priority 2: Fasting Blood Sugar #}
                                {% if record.sugarFasting %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Fasting: {{ record.sugarFasting }} mg/dL</span>
                                {% endif %}
                                
                                {# Priority 3: HbA1c #}
                                {% if record.hbA1c %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">HbA1c: {{ record.hbA1c }}%</span>
                                {% endif %}
                                
                                {# Priority 4: Weight #}
                                {% if record.weight %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Weight: {{ record.weight }} kg</span>
                                {% endif %}
                                
                                {# Priority 5: BMI #}
                                {% if record.bmi %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">BMI: {{ record.bmi }}</span>
                                {% endif %}
                                
                                {# Additional metrics to reach minimum 5 #}
                                {% if displayed_metrics|length < 5 and record.heartRate %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">HR: {{ record.heartRate }} bpm</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.spo2 %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">SpO2: {{ record.spo2 }}%</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.cholesterolTotal %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Cholesterol: {{ record.cholesterolTotal }} mg/dL</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.hemoglobin %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Hb: {{ record.hemoglobin }} g/dL</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.serumCreatinine %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Creatinine: {{ record.serumCreatinine }} mg/dL</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.sugarPostMeal %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Post-Meal: {{ record.sugarPostMeal }} mg/dL</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.cholesterolLDL %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">LDL: {{ record.cholesterolLDL }} mg/dL</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.temperature %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">Temp: {{ record.temperature }} ¬∞C</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.eGFR %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">eGFR: {{ record.eGFR }}</span>
                                {% endif %}
                                
                                {% if displayed_metrics|length < 5 and record.tsh %}
                                    {{ displayed_metrics.append(1) or '' }}
                                    <span class="metric">TSH: {{ record.tsh }} ŒºIU/mL</span>
                                {% endif %}
                                
                                {# Fallback if no metrics at all #}
                                {% if displayed_metrics|length == 0 %}
                                    <span class="metric">No metrics recorded</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ record.notes[:50] if record.notes else '-' }}{{ '...' if record.notes and record.notes|length > 50 else '' }}</td>
                        <td>
                            <button onclick="viewRecordDetails('{{ record._id }}')" class="btn btn-sm btn-outline">
                                üëÅÔ∏è View
                            </button>
                            <button onclick="confirmDeleteRecord('{{ record._id }}')" class="btn btn-sm btn-danger" style="background: #ef4444; margin-left: 5px;">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <h3>No health records yet</h3>
            <p>Add a health record manually or upload a lab report to get started.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Lab Report</h3>
            <button onclick="document.getElementById('uploadModal').style.display='none'" class="modal-close">&times;</button>
        </div>
        
        <form id="uploadForm" method="POST" action="{{ url_for('records.upload_report', patient_id=patient._id) }}" enctype="multipart/form-data" onsubmit="return handleUploadSubmit(event)">
            <div class="modal-body">
                <p>Upload a lab report (PDF or image) to automatically extract health data using AI.</p>
                
                <div class="form-group">
                    <label for="reportFile">Select File</label>
                    <input 
                        type="file" 
                        id="reportFile" 
                        name="reportFile" 
                        class="form-control" 
                        accept=".pdf,.png,.jpg,.jpeg"
                        required
                    >
                    <small class="form-hint">Accepted formats: PDF, PNG, JPG, JPEG (Max 16MB)</small>
                </div>
                
                <!-- Loading Indicator -->
                <div id="uploadLoading" style="display: none; margin-top: 20px;">
                    <div class="loading-bar">
                        <div class="loading-bar-progress"></div>
                    </div>
                    <p style="text-align: center; color: #8b5cf6; margin-top: 10px; font-weight: 600;">
                        ü§ñ AI is extracting data from your report... Please wait.
                    </p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="submit" id="uploadBtn" class="btn btn-primary">üì§ Upload & Extract</button>
                <button type="button" onclick="document.getElementById('uploadModal').style.display='none'" class="btn btn-outline">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Record Details Modal -->
<div id="recordModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Health Record Details</h3>
            <button onclick="document.getElementById('recordModal').style.display='none'" class="modal-close">&times;</button>
        </div>
        
        <div class="modal-body" id="recordModalBody">
            <p style="text-align: center; color: #666;">Loading...</p>
        </div>
        
        <div class="modal-footer">
            <button type="button" onclick="document.getElementById('recordModal').style.display='none'" class="btn btn-outline">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart data from Flask (with fallback structure)
const chartData = {{ (chart_data | default({
    'labels': [],
    'sugar': {'fasting': [], 'postMeal': [], 'hbA1c': []},
    'bloodPressure': {'systolic': [], 'diastolic': []},
    'lipids': {'total': [], 'hdl': [], 'ldl': [], 'triglycerides': []},
    'weight': {'weight': [], 'bmi': []},
    'kidney': {'creatinine': [], 'egfr': []},
    'thyroid': {'tsh': [], 't3': [], 't4': []}
})) | tojson | safe }};

// Debug: Log chart data to console
console.log('Chart Data Received:', chartData);

// Create charts
document.addEventListener('DOMContentLoaded', function() {
    console.log('Creating charts...');
    
    // Sugar Chart
    createLineChart('sugarChart', chartData, {
        'Fasting': chartData.sugar.fasting,
        'Post-Meal': chartData.sugar.postMeal,
        'HbA1c': chartData.sugar.hbA1c
    }, ['#3b82f6', '#8b5cf6', '#ec4899']);
    
    // BP Chart
    createLineChart('bpChart', chartData, {
        'Systolic': chartData.bloodPressure.systolic,
        'Diastolic': chartData.bloodPressure.diastolic
    }, ['#ef4444', '#f97316']);
    
    // Lipids Chart
    createLineChart('lipidsChart', chartData, {
        'Total': chartData.lipids.total,
        'HDL': chartData.lipids.hdl,
        'LDL': chartData.lipids.ldl,
        'Triglycerides': chartData.lipids.triglycerides
    }, ['#6366f1', '#10b981', '#f59e0b', '#ef4444']);
    
    // Weight Chart
    createLineChart('weightChart', chartData, {
        'Weight (kg)': chartData.weight.weight,
        'BMI': chartData.weight.bmi
    }, ['#8b5cf6', '#ec4899']);
    
    // Kidney Chart
    createLineChart('kidneyChart', chartData, {
        'Creatinine': chartData.kidney.creatinine,
        'eGFR': chartData.kidney.egfr
    }, ['#f59e0b', '#10b981']);
    
    // Thyroid Chart
    createLineChart('thyroidChart', chartData, {
        'TSH': chartData.thyroid.tsh,
        'T3': chartData.thyroid.t3,
        'T4': chartData.thyroid.t4
    }, ['#3b82f6', '#8b5cf6', '#ec4899']);
});

function createLineChart(canvasId, chartData, datasets, colors) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.warn(`Canvas element not found: ${canvasId}`);
        return;
    }
    
    console.log(`Creating chart for ${canvasId}:`, {
        labels: chartData.labels,
        datasets: datasets
    });
    
    const chartDatasets = [];
    let datasetIndex = 0;
    
    for (const [label, data] of Object.entries(datasets)) {
        console.log(`  Dataset "${label}":`, data);
        
        // Only add dataset if it has at least one non-null value
        if (data && data.some(v => v !== null && v !== undefined)) {
            console.log(`    ‚úì Adding dataset "${label}" (has data)`);
            chartDatasets.push({
                label: label,
                data: data,
                borderColor: colors[datasetIndex % colors.length],
                backgroundColor: colors[datasetIndex % colors.length] + '20',
                tension: 0.3,
                fill: false
            });
            datasetIndex++;
        } else {
            console.log(`    ‚úó Skipping dataset "${label}" (no data)`);
        }
    }
    
    // Always create chart (empty if no data, plotted if data exists)
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels || [],
            datasets: chartDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                    display: chartDatasets.length > 0 // Hide legend if no data
                },
                title: {
                    display: chartDatasets.length === 0,
                    text: 'No data available',
                    color: '#64748b',
                    font: {
                        size: 14
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        display: true
                    }
                },
                x: {
                    grid: {
                        display: true
                    }
                }
            }
        }
    });
}

// View record details
async function viewRecordDetails(recordId) {
    const modal = document.getElementById('recordModal');
    const modalBody = document.getElementById('recordModalBody');
    
    // Show modal with loading state
    modal.style.display = 'flex';
    modalBody.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';
    
    try {
        const response = await fetch(`/api/records/${recordId}`);
        if (!response.ok) throw new Error('Failed to fetch record');
        
        const record = await response.json();
        
        // Build detailed view
        let html = `
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: #6366f1;">Record Information</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div><strong>Date:</strong> ${record.timestamp || 'N/A'}</div>
                    <div><strong>Source:</strong> <span class="badge badge-${record.sourceType === 'REPORT_AI' ? 'ai' : 'manual'}">${record.sourceType || 'N/A'}</span></div>
                </div>
            </div>
        `;
        
        // Vitals
        if (record.bpSystolic || record.bpDiastolic || record.heartRate || record.temperature || record.spo2 || record.weight || record.height || record.bmi) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Vitals</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.bpSystolic && record.bpDiastolic) html += `<div><strong>Blood Pressure:</strong> ${record.bpSystolic}/${record.bpDiastolic} mmHg</div>`;
            if (record.heartRate) html += `<div><strong>Heart Rate:</strong> ${record.heartRate} bpm</div>`;
            if (record.temperature) html += `<div><strong>Temperature:</strong> ${record.temperature} ¬∞C</div>`;
            if (record.spo2) html += `<div><strong>SpO2:</strong> ${record.spo2}%</div>`;
            if (record.weight) html += `<div><strong>Weight:</strong> ${record.weight} kg</div>`;
            if (record.height) html += `<div><strong>Height:</strong> ${record.height} cm</div>`;
            if (record.bmi) html += `<div><strong>BMI:</strong> ${record.bmi}</div>`;
            html += '</div></div>';
        }
        
        // Diabetes
        if (record.sugarFasting || record.sugarPostMeal || record.randomBloodSugar || record.hbA1c) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Diabetes / Glucose</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.sugarFasting) html += `<div><strong>Fasting:</strong> ${record.sugarFasting} mg/dL</div>`;
            if (record.sugarPostMeal) html += `<div><strong>Post-Meal:</strong> ${record.sugarPostMeal} mg/dL</div>`;
            if (record.randomBloodSugar) html += `<div><strong>Random:</strong> ${record.randomBloodSugar} mg/dL</div>`;
            if (record.hbA1c) html += `<div><strong>HbA1c:</strong> ${record.hbA1c}%</div>`;
            html += '</div></div>';
        }
        
        // Lipid Profile
        if (record.cholesterolTotal || record.cholesterolHDL || record.cholesterolLDL || record.triglycerides || record.vldl) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Lipid Profile</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.cholesterolTotal) html += `<div><strong>Total Cholesterol:</strong> ${record.cholesterolTotal} mg/dL</div>`;
            if (record.cholesterolHDL) html += `<div><strong>HDL:</strong> ${record.cholesterolHDL} mg/dL</div>`;
            if (record.cholesterolLDL) html += `<div><strong>LDL:</strong> ${record.cholesterolLDL} mg/dL</div>`;
            if (record.triglycerides) html += `<div><strong>Triglycerides:</strong> ${record.triglycerides} mg/dL</div>`;
            if (record.vldl) html += `<div><strong>VLDL:</strong> ${record.vldl} mg/dL</div>`;
            html += '</div></div>';
        }
        
        // Kidney Function
        if (record.serumCreatinine || record.bloodUrea || record.bun || record.eGFR) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Kidney Function</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.serumCreatinine) html += `<div><strong>Creatinine:</strong> ${record.serumCreatinine} mg/dL</div>`;
            if (record.bloodUrea) html += `<div><strong>Blood Urea:</strong> ${record.bloodUrea} mg/dL</div>`;
            if (record.bun) html += `<div><strong>BUN:</strong> ${record.bun} mg/dL</div>`;
            if (record.eGFR) html += `<div><strong>eGFR:</strong> ${record.eGFR} mL/min/1.73m¬≤</div>`;
            html += '</div></div>';
        }
        
        // Liver Function
        if (record.sgptAlt || record.sgotAst || record.alkalinePhosphatase || record.totalBilirubin || record.directBilirubin || record.indirectBilirubin) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Liver Function</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.sgptAlt) html += `<div><strong>SGPT/ALT:</strong> ${record.sgptAlt} U/L</div>`;
            if (record.sgotAst) html += `<div><strong>SGOT/AST:</strong> ${record.sgotAst} U/L</div>`;
            if (record.alkalinePhosphatase) html += `<div><strong>ALP:</strong> ${record.alkalinePhosphatase} U/L</div>`;
            if (record.totalBilirubin) html += `<div><strong>Total Bilirubin:</strong> ${record.totalBilirubin} mg/dL</div>`;
            if (record.directBilirubin) html += `<div><strong>Direct Bilirubin:</strong> ${record.directBilirubin} mg/dL</div>`;
            if (record.indirectBilirubin) html += `<div><strong>Indirect Bilirubin:</strong> ${record.indirectBilirubin} mg/dL</div>`;
            html += '</div></div>';
        }
        
        // Electrolytes
        if (record.sodium || record.potassium || record.chloride) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Electrolytes</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.sodium) html += `<div><strong>Sodium:</strong> ${record.sodium} mEq/L</div>`;
            if (record.potassium) html += `<div><strong>Potassium:</strong> ${record.potassium} mEq/L</div>`;
            if (record.chloride) html += `<div><strong>Chloride:</strong> ${record.chloride} mEq/L</div>`;
            html += '</div></div>';
        }
        
        // Hematology
        if (record.hemoglobin || record.totalLeukocyteCount || record.plateletCount || record.rbcCount || record.pcv || record.mcv) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Hematology (CBC)</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.hemoglobin) html += `<div><strong>Hemoglobin:</strong> ${record.hemoglobin} g/dL</div>`;
            if (record.totalLeukocyteCount) html += `<div><strong>WBC:</strong> ${record.totalLeukocyteCount} cells/ŒºL</div>`;
            if (record.plateletCount) html += `<div><strong>Platelets:</strong> ${record.plateletCount} lakhs</div>`;
            if (record.rbcCount) html += `<div><strong>RBC:</strong> ${record.rbcCount} million/ŒºL</div>`;
            if (record.pcv) html += `<div><strong>PCV:</strong> ${record.pcv}%</div>`;
            if (record.mcv) html += `<div><strong>MCV:</strong> ${record.mcv} fL</div>`;
            html += '</div></div>';
        }
        
        // Thyroid
        if (record.tsh || record.t3 || record.t4) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Thyroid Function</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.tsh) html += `<div><strong>TSH:</strong> ${record.tsh} ŒºIU/mL</div>`;
            if (record.t3) html += `<div><strong>T3:</strong> ${record.t3} ng/dL</div>`;
            if (record.t4) html += `<div><strong>T4:</strong> ${record.t4} Œºg/dL</div>`;
            html += '</div></div>';
        }
        
        // Vitamins
        if (record.vitaminD || record.vitaminB12) {
            html += '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Vitamins</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            if (record.vitaminD) html += `<div><strong>Vitamin D:</strong> ${record.vitaminD} ng/mL</div>`;
            if (record.vitaminB12) html += `<div><strong>Vitamin B12:</strong> ${record.vitaminB12} pg/mL</div>`;
            html += '</div></div>';
        }
        
        // Notes
        if (record.notes) {
            html += `<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px; color: #6366f1;">Notes</h4><p style="white-space: pre-wrap;">${record.notes}</p></div>`;
        }
        
        modalBody.innerHTML = html;
        
    } catch (error) {
        modalBody.innerHTML = '<p style="text-align: center; color: #ef4444;">Failed to load record details. Please try again.</p>';
        console.error('Error loading record:', error);
    }
}

// Delete patient confirmation
function confirmDeletePatient(patientId, patientName) {
    if (confirm(`Are you sure you want to delete patient "${patientName}" and ALL their health records?\n\nThis action CANNOT be undone!`)) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action =`/patients/${patientId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Delete health record confirmation
async function confirmDeleteRecord(recordId) {
    if (confirm('Are you sure you want to delete this health record?\n\nThis action cannot be undone.')) {
        try {
            const response = await fetch(`/api/records/${recordId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Health record deleted successfully!');
                // Reload the page to refresh the records list
                window.location.reload();
            } else {
                alert('Failed to delete record: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error deleting record: ' + error.message);
            console.error('Error:', error);
        }
    }
}

// Handle upload form submission
function handleUploadSubmit(event) {
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadLoading = document.getElementById('uploadLoading');
    const fileInput = document.getElementById('reportFile');
    
    // Check if file is selected
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select a file to upload');
        return false;
    }
    
    // Disable button and show loading
    uploadBtn.disabled = true;
    uploadBtn.textContent = '‚è≥ Processing...';
    uploadBtn.style.opacity = '0.6';
    uploadBtn.style.cursor = 'not-allowed';
    uploadLoading.style.display = 'block';
    
    // Allow form to submit normally
    return true;
}
</script>
{% endblock %}
